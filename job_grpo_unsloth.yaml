description: GRPO on decomposition training


environment:
  # image: amlt-sing/acpt-torch2.3.1-py3.10-cuda12.1-ubuntu22.04:20240918T133309423
  image: lesong/nvidia-cuda-mujoco:v6
  username: f2e15e898c154795b7a8c9a9d936095d
  registry: f2e15e898c154795b7a8c9a9d936095d.azurecr.io

  setup:
    - apt-get update -y
    - pip install unsloth vllm
    - pip install --upgrade pillow
    - pip install diffusers
    - pip install git+https://github.com/huggingface/trl.git@e95f9fb74a3c3647b86f251b7e230ec51c64b72b
    - pip install omegaconf
    - pip install pydotenv

target:
  service: sing
  # name: palisades03
  name: msrresrchvc
  # msrresrchvc: A100-80G
  # name: msrresrchlab
  # name: msroctobasicvc
  workspace_name: rag-workspace-eastus

data:
  local_dir: data/
  remote_dir: data/

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: ./

# python experiment.py --seed 123 --env hopper --dataset medium-expert --eta 1.0 --grad_norm 9.0 --exp_name qt --save_path ./save/ --max_iters 100 --num_steps_per_iter 10000 --lr_decay --early_stop --k_rewards --use_discount --reprogram --desc_reg

# jobs:
# - name: GRPO_MH_phi4_unsloth
#   identity: managed
#   submit_args:
#     env:
#       _AZUREML_SINGULARITY_JOB_UAI: "/subscriptions/e033d461-1923-44a7-872b-78f1d35a86dd/resourcegroups/RAG-WUS/providers/Microsoft.ManagedIdentity/userAssignedIdentities/rag-workspace-eastus-mi"
#   sku: 80G1
#   # preemptible: True
#   command:
#     - python grpo_unsloth.py base_model=unsloth/Phi-4

# - name: GRPO_MH_llama8b_unsloth
#   identity: managed
#   submit_args:
#     env:
#       _AZUREML_SINGULARITY_JOB_UAI: "/subscriptions/e033d461-1923-44a7-872b-78f1d35a86dd/resourcegroups/RAG-WUS/providers/Microsoft.ManagedIdentity/userAssignedIdentities/rag-workspace-eastus-mi"
#   sku: 80G1
#   # preemptible: True
#   command:
#     - python grpo_unsloth.py base_model=unsloth/Meta-Llama-3.1-8B-Instruct


# - name: GRPO_MH_Qwen14b_unsloth
#   identity: managed
#   submit_args:
#     env:
#       _AZUREML_SINGULARITY_JOB_UAI: "/subscriptions/e033d461-1923-44a7-872b-78f1d35a86dd/resourcegroups/RAG-WUS/providers/Microsoft.ManagedIdentity/userAssignedIdentities/rag-workspace-eastus-mi"
#   sku: 80G1
#   # preemptible: True
#   command:
    # - python grpo_unsloth.py base_model=unsloth/Qwen2.5-14B-Instruct

search:
  job_template:
    # you may use {random_string:s} to avoid job name collisions
    # {auto:3s} generates lr_0.00000_mom_0.5, .. etc
    # {auto:2s} generates lr_0.00000_mo_0.5, .. etc
    name: "{experiment_name:s}_{auto:3s}"
    identity: managed
    submit_args:
      env:
        _AZUREML_SINGULARITY_JOB_UAI: "/subscriptions/e033d461-1923-44a7-872b-78f1d35a86dd/resourcegroups/RAG-WUS/providers/Microsoft.ManagedIdentity/userAssignedIdentities/rag-workspace-eastus-mi"
    sku: 80G1
    command:
    - python grpo_unsloth.py base_model={base_model} r={r} alpha={alpha}
  type: hyperdrive  # hyperparameter search type: hyperdrive, random, grid.  Default: hyperdrive
  sampling: grid  # how to explore the hyperparameter space: random, grid or bayesian. Default: bayesian
  max_trials: 18
  params:
    - name: base_model
      values: ["unsloth/Qwen2.5-14B-Instruct", "unsloth/Meta-Llama-3.1-8B-Instruct", "unsloth/Phi-4"]
    - name: r
      values: [16, 32]  # or equivalently choice(0.5, 0.9, 0.99)
    - name: alpha
      values: [16, 32, 64]  # or equivalently choice(0.5, 0.9, 0.99)
      